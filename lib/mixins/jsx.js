'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var constants = require('../constants'),
    nameUtilities = require('../utilities/name'),
    arrayUtilities = require('../utilities/array'),
    objectUtilities = require('../utilities/object'),
    elementsUtilities = require('../utilities/elements');

var first = arrayUtilities.first,
    combine = objectUtilities.combine,
    prune = objectUtilities.prune,
    SVG_NAMESPACE_URI = constants.SVG_NAMESPACE_URI,
    isHTMLAttributeName = nameUtilities.isHTMLAttributeName,
    isSVGAttributeName = nameUtilities.isSVGAttributeName,
    removeFalseyElements = elementsUtilities.removeFalseyElements,
    replaceStringsWithTextElements = elementsUtilities.replaceStringsWithTextElements;


function applyProperties() {
  var properties = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  var _this = this;

  var defaultProperties = arguments[1];
  var ignoredProperties = arguments[2];

  combine(properties, defaultProperties);

  var childElements = childElementsFromElementAndProperties(this, properties) || properties.childElements; ///

  prune(properties, ignoredProperties);

  var names = Object.keys(properties),
      ///
  svg = this.domElement.namespaceURI === SVG_NAMESPACE_URI;

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {
      ///
    } else if (isHandlerName(name)) {
      addHandler(_this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(_this, name, value);
    } else {
      if (!_this.hasOwnProperty('properties')) {
        var _properties = {};

        Object.assign(_this, {
          properties: _properties
        });
      }

      _this.properties[name] = value;
    }
  });

  var context = {};

  childElements.forEach(function (childElement) {
    updateContext(childElement, context);

    childElement.addTo(_this);
  });

  Object.assign(this, {
    context: context
  });
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function assignContext(names, thenDelete) {
  var _this2 = this;

  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = first(arguments);

    if (typeof firstArgument === 'boolean') {
      names = Object.keys(this.context);

      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);

    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = _this2.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };

    Object.defineProperty(_this2, propertyName, descriptor);

    if (thenDelete) {
      delete _this2.context[name];
    }
  }, []);
}

module.exports = {
  applyProperties: applyProperties,
  getProperties: getProperties,
  getContext: getContext,
  assignContext: assignContext
};

function childElementsFromElementAndProperties(element, properties) {
  var childElements = null;

  if (typeof element.childElements === 'function') {
    childElements = element.childElements(properties);

    if (!(childElements instanceof Array)) {
      childElements = [childElements];
    }

    childElements = removeFalseyElements(childElements);

    childElements = replaceStringsWithTextElements(childElements);
  }

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === 'function' ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);

  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === 'className') {
    name = 'class';
  }

  if (name === 'htmlFor') {
    name = 'for';
  }

  if ((typeof value === 'undefined' ? 'undefined' : _typeof(value)) === 'object') {
    var keys = Object.keys(value);

    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    });
  } else if (typeof value === 'boolean') {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? isSVGAttributeName(name) : isHTMLAttributeName(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9taXhpbnMvanN4LmpzIl0sIm5hbWVzIjpbImNvbnN0YW50cyIsInJlcXVpcmUiLCJuYW1lVXRpbGl0aWVzIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJlbGVtZW50c1V0aWxpdGllcyIsImZpcnN0IiwiY29tYmluZSIsInBydW5lIiwiU1ZHX05BTUVTUEFDRV9VUkkiLCJpc0hUTUxBdHRyaWJ1dGVOYW1lIiwiaXNTVkdBdHRyaWJ1dGVOYW1lIiwicmVtb3ZlRmFsc2V5RWxlbWVudHMiLCJyZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMiLCJhcHBseVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZGVmYXVsdFByb3BlcnRpZXMiLCJpZ25vcmVkUHJvcGVydGllcyIsImNoaWxkRWxlbWVudHMiLCJjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzIiwibmFtZXMiLCJPYmplY3QiLCJrZXlzIiwic3ZnIiwiZG9tRWxlbWVudCIsIm5hbWVzcGFjZVVSSSIsImZvckVhY2giLCJuYW1lIiwidmFsdWUiLCJpc0hhbmRsZXJOYW1lIiwiYWRkSGFuZGxlciIsImlzQXR0cmlidXRlTmFtZSIsImFkZEF0dHJpYnV0ZSIsImhhc093blByb3BlcnR5IiwiYXNzaWduIiwiY29udGV4dCIsImNoaWxkRWxlbWVudCIsInVwZGF0ZUNvbnRleHQiLCJhZGRUbyIsImdldFByb3BlcnRpZXMiLCJnZXRDb250ZXh0IiwiYXNzaWduQ29udGV4dCIsInRoZW5EZWxldGUiLCJhcmd1bWVudHNMZW5ndGgiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJmaXJzdEFyZ3VtZW50IiwicHJvcGVydHlOYW1lIiwiZGVzY3JpcHRvciIsImRlZmluZVByb3BlcnR5IiwibW9kdWxlIiwiZXhwb3J0cyIsImVsZW1lbnQiLCJBcnJheSIsInBhcmVudENvbnRleHQiLCJldmVudFR5cGUiLCJzdWJzdHIiLCJ0b0xvd2VyQ2FzZSIsImhhbmRsZXIi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R0FBTixDQUFoQztBQUNELEtBRkQ7QUFHRCxHQU5ELE1BTU8sSUFBSSxPQUFPaEMsS0FBUCxLQUFpQixTQUFyQixFQUFnQztBQUNyQyxRQUFJQSxLQUFKLEVBQVc7QUFDVEEsY0FBUUQsSUFBUixDQURTLENBQ0s7O0FBRWR5QixjQUFRcEIsWUFBUixDQUFxQkwsSUFBckIsRUFBMkJDLEtBQTNCO0FBQ0Q7QUFDRixHQU5NLE1BTUE7QUFDTHdCLFlBQVFwQixZQUFSLENBQXFCTCxJQUFyQixFQUEyQkMsS0FBM0I7QUFDRDtBQUNGOztBQUVELFNBQVNDLGFBQVQsQ0FBdUJGLElBQXZCLEVBQTZCO0FBQzNCLFNBQU9BLEtBQUtrQyxLQUFMLENBQVcsS0FBWCxDQUFQO0FBQ0Q7O0FBRUQsU0FBUzlCLGVBQVQsQ0FBeUJKLElBQXpCLEVBQStCSixHQUEvQixFQUFvQztBQUNsQyxTQUFPQSxNQUFNWixtQkFBbUJnQixJQUFuQixDQUFOLEdBQWlDakIsb0JBQW9CaUIsSUFBcEIsQ0FBeEM7QUFDRCIsImZpbGUiOiJqc3guanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4uL2NvbnN0YW50cycpLFxuICAgICAgbmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9uYW1lJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgb2JqZWN0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL29iamVjdCcpLFxuICAgICAgZWxlbWVudHNVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvZWxlbWVudHMnKTtcblxuY29uc3QgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGNvbWJpbmUsIHBydW5lIH0gPSBvYmplY3RVdGlsaXRpZXMsXG4gICAgICB7IFNWR19OQU1FU1BBQ0VfVVJJIH0gPSBjb25zdGFudHMsXG4gICAgICB7IGlzSFRNTEF0dHJpYnV0ZU5hbWUsIGlzU1ZHQXR0cmlidXRlTmFtZSB9ID0gbmFtZVV0aWxpdGllcyxcbiAgICAgIHsgcmVtb3ZlRmFsc2V5RWxlbWVudHMsIHJlcGxhY2VTdHJpbmdzV2l0aFRleHRFbGVtZW50cyB9ID0gZWxlbWVudHNVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGFwcGx5UHJvcGVydGllcyhwcm9wZXJ0aWVzID0ge30sIGRlZmF1bHRQcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcykge1xuICBjb21iaW5lKHByb3BlcnRpZXMsIGRlZmF1bHRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBjaGlsZEVsZW1lbnRzID0gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyh0aGlzLCBwcm9wZXJ0aWVzKSB8fCBwcm9wZXJ0aWVzLmNoaWxkRWxlbWVudHM7ICAvLy9cblxuICBwcnVuZShwcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcyk7XG5cbiAgY29uc3QgbmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgIC8vL1xuICAgICAgICBzdmcgPSAodGhpcy5kb21FbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRV9VUkkpO1xuXG4gIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IHByb3BlcnRpZXNbbmFtZV07XG5cbiAgICBpZiAoZmFsc2UpIHtcbiAgICAgIC8vL1xuICAgIH0gZWxzZSBpZiAoaXNIYW5kbGVyTmFtZShuYW1lKSkge1xuICAgICAgYWRkSGFuZGxlcih0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChpc0F0dHJpYnV0ZU5hbWUobmFtZSwgc3ZnKSkge1xuICAgICAgYWRkQXR0cmlidXRlKHRoaXMsIG5hbWUsIHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KCdwcm9wZXJ0aWVzJykpIHtcbiAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IHt9O1xuXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgICAgIHByb3BlcnRpZXNcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucHJvcGVydGllc1tuYW1lXSA9IHZhbHVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgY29udGV4dCA9IHt9O1xuXG4gIGNoaWxkRWxlbWVudHMuZm9yRWFjaCgoY2hpbGRFbGVtZW50KSA9PiB7XG4gICAgdXBkYXRlQ29udGV4dChjaGlsZEVsZW1lbnQsIGNvbnRleHQpO1xuXG4gICAgY2hpbGRFbGVtZW50LmFkZFRvKHRoaXMpO1xuICB9KTtcblxuICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICBjb250ZXh0XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKCkge1xuICByZXR1cm4gdGhpcy5wcm9wZXJ0aWVzO1xufVxuXG5mdW5jdGlvbiBnZXRDb250ZXh0KCkge1xuICByZXR1cm4gdGhpcy5jb250ZXh0O1xufVxuXG5mdW5jdGlvbiBhc3NpZ25Db250ZXh0KG5hbWVzLCB0aGVuRGVsZXRlKSB7XG4gIGNvbnN0IGFyZ3VtZW50c0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7XG5cbiAgaWYgKGFyZ3VtZW50c0xlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IGZpcnN0QXJndW1lbnQgPSBmaXJzdChhcmd1bWVudHMpO1xuXG4gICAgaWYgKHR5cGVvZiBmaXJzdEFyZ3VtZW50ID09PSAnYm9vbGVhbicpIHtcbiAgICAgIG5hbWVzID0gT2JqZWN0LmtleXModGhpcy5jb250ZXh0KTtcblxuICAgICAgdGhlbkRlbGV0ZSA9IGZpcnN0QXJndW1lbnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoZW5EZWxldGUgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhcmd1bWVudHNMZW5ndGggPT09IDApIHtcbiAgICBuYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuY29udGV4dCk7XG5cbiAgICB0aGVuRGVsZXRlID0gdHJ1ZTtcbiAgfVxuXG4gIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuY29udGV4dFtuYW1lXSxcbiAgICAgICAgICBwcm9wZXJ0eU5hbWUgPSBuYW1lLCAgLy8vXG4gICAgICAgICAgZGVzY3JpcHRvciA9IHtcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICAgIH07XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCBkZXNjcmlwdG9yKTtcblxuICAgIGlmICh0aGVuRGVsZXRlKSB7XG4gICAgICBkZWxldGUgdGhpcy5jb250ZXh0W25hbWVdO1xuICAgIH1cbiAgfSwgW10pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgYXBwbHlQcm9wZXJ0aWVzLFxuICBnZXRQcm9wZXJ0aWVzLFxuICBnZXRDb250ZXh0LFxuICBhc3NpZ25Db250ZXh0XG59O1xuXG5mdW5jdGlvbiBjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzKGVsZW1lbnQsIHByb3BlcnRpZXMpIHtcbiAgbGV0IGNoaWxkRWxlbWVudHMgPSBudWxsO1xuXG4gIGlmICh0eXBlb2YgZWxlbWVudC5jaGlsZEVsZW1lbnRzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY2hpbGRFbGVtZW50cyA9IGVsZW1lbnQuY2hpbGRFbGVtZW50cyhwcm9wZXJ0aWVzKTtcblxuICAgIGlmICghKGNoaWxkRWxlbWVudHMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgIGNoaWxkRWxlbWVudHMgPSBbY2hpbGRFbGVtZW50c107XG4gICAgfVxuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlbW92ZUZhbHNleUVsZW1lbnRzKGNoaWxkRWxlbWVudHMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlcGxhY2VTdHJpbmdzV2l0aFRleHRFbGVtZW50cyhjaGlsZEVsZW1lbnRzKTtcbiAgfVxuXG4gIHJldHVybiBjaGlsZEVsZW1lbnRzO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCkge1xuICBjb25zdCBwYXJlbnRDb250ZXh0ID0gKHR5cGVvZiBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCgpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQuY29udGV4dDsgLy8vXG5cbiAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCBwYXJlbnRDb250ZXh0KTtcblxuICBkZWxldGUgY2hpbGRFbGVtZW50LmNvbnRleHQ7XG59XG5cbmZ1bmN0aW9uIGFkZEhhbmRsZXIoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHtcbiAgY29uc3QgZXZlbnRUeXBlID0gbmFtZS5zdWJzdHIoMikudG9Mb3dlckNhc2UoKSwgLy8vXG4gICAgICAgIGhhbmRsZXIgPSB2YWx1ZTsgIC8vL1xuXG4gIGVsZW1lbnQub24oZXZlbnRUeXBlLCBoYW5kbGVyKTtcbn1cblxuZnVuY3Rpb24gYWRkQXR0cmlidXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7XG4gIGlmIChuYW1lID09PSAnY2xhc3NOYW1lJykge1xuICAgIG5hbWUgPSAnY2xhc3MnO1xuICB9XG5cbiAgaWYgKG5hbWUgPT09ICdodG1sRm9yJykge1xuICAgIG5hbWUgPSAnZm9yJztcbiAgfVxuXG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTtcblxuICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgIGVsZW1lbnQuZG9tRWxlbWVudFtuYW1lXVtrZXldID0gdmFsdWVba2V5XTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykge1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdmFsdWUgPSBuYW1lOyAvLy9cblxuICAgICAgZWxlbWVudC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBlbGVtZW50LmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNIYW5kbGVyTmFtZShuYW1lKSB7XG4gIHJldHVybiBuYW1lLm1hdGNoKC9eb24vKTtcbn1cblxuZnVuY3Rpb24gaXNBdHRyaWJ1dGVOYW1lKG5hbWUsIHN2Zykge1xuICByZXR1cm4gc3ZnID8gaXNTVkdBdHRyaWJ1dGVOYW1lKG5hbWUpIDogaXNIVE1MQXR0cmlidXRlTmFtZShuYW1lKVxufVxuIl19