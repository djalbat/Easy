"use strict";

var _object = require("../utilities/object");

var _array = require("../utilities/array");

var _constants = require("../constants");

var _name = require("../utilities/name");

var _elements = require("../utilities/elements");

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function applyProperties() {
  var _this = this;

  var properties = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var defaultProperties = arguments.length > 1 ? arguments[1] : undefined;
  var ignoredProperties = arguments.length > 2 ? arguments[2] : undefined;
  (0, _object.combine)(properties, defaultProperties);
  var childElements = childElementsFromElementAndProperties(this, properties) || properties.childElements; ///

  (0, _object.prune)(properties, ignoredProperties);
  var svg = this.domElement.namespaceURI === _constants.SVG_NAMESPACE_URI,
      ///
  names = Object.keys(properties); ///

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {///
    } else if (isHandlerName(name)) {
      addHandler(_this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(_this, name, value);
    } else {
      if (!_this.hasOwnProperty("properties")) {
        var _properties = {};
        Object.assign(_this, {
          properties: _properties
        });
      }

      _this.properties[name] = value;
    }
  });
  var context = {};
  childElements.forEach(function (childElement) {
    updateContext(childElement, context);
    childElement.addTo(_this);
  });
  Object.assign(this, {
    context: context
  });
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function assignContext(names, thenDelete) {
  var _this2 = this;

  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = (0, _array.first)(arguments);

    if (typeof firstArgument === "boolean") {
      names = Object.keys(this.context);
      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);
    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = _this2.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };
    Object.defineProperty(_this2, propertyName, descriptor);

    if (thenDelete) {
      delete _this2.context[name];
    }
  }, []);
}

module.exports = {
  applyProperties: applyProperties,
  getProperties: getProperties,
  getContext: getContext,
  assignContext: assignContext
};

function childElementsFromElementAndProperties(element, properties) {
  var childElements = null;

  if (typeof element.childElements === "function") {
    childElements = element.childElements(properties);
    childElements = (0, _array.guarantee)(childElements);
    childElements = (0, _elements.removeFalseyElements)(childElements);
    childElements = (0, _elements.replaceStringsWithTextElements)(childElements);
  }

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === "function" ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);
  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === "className") {
    name = "class";
  }

  if (name === "htmlFor") {
    name = "for";
  }

  if (_typeof(value) === "object") {
    var keys = Object.keys(value);
    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    });
  } else if (typeof value === "boolean") {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? (0, _name.isSVGAttributeName)(name) : (0, _name.isHTMLAttributeName)(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzeC5qcyJdLCJuYW1lcyI6WyJhcHBseVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZGVmYXVsdFByb3BlcnRpZXMiLCJpZ25vcmVkUHJvcGVydGllcyIsImNoaWxkRWxlbWVudHMiLCJjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzIiwic3ZnIiwiZG9tRWxlbWVudCIsIm5hbWVzcGFjZVVSSSIsIlNWR19OQU1FU1BBQ0VfVVJJIiwibmFtZXMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsIm5hbWUiLCJ2YWx1ZSIsImlzSGFuZGxlck5hbWUiLCJhZGRIYW5kbGVyIiwiaXNBdHRyaWJ1dGVOYW1lIiwiYWRkQXR0cmlidXRlIiwiaGFzT3duUHJvcGVydHkiLCJhc3NpZ24iLCJjb250ZXh0IiwiY2hpbGRFbGVtZW50IiwidXBkYXRlQ29udGV4dCIsImFkZFRvIiwiZ2V0UHJvcGVydGllcyIsImdldENvbnRleHQiLCJhc3NpZ25Db250ZXh0IiwidGhlbkRlbGV0ZSIsImFyZ3VtZW50c0xlbmd0aCIsImFyZ3VtZW50cyIsImxlbmd0aCIsImZpcnN0QXJndW1lbnQiLCJwcm9wZXJ0eU5hbWUiLCJkZXNjcmlwdG9yIiwiZGVmaW5lUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZWxlbWVudCIsInBhcmVudENvbnRleHQiLCJldmVudFR5cGUiLCJzdWJzdHIiLCJ0b0xvd2VyQ2FzZSIsImhhbmRsZXIiLCJvbiIsImtleSIsIm1hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLFNBQVNBLGVBQVQsR0FBZ0Y7QUFBQTs7QUFBQSxNQUF2REMsVUFBdUQsdUVBQTFDLEVBQTBDO0FBQUEsTUFBdENDLGlCQUFzQztBQUFBLE1BQW5CQyxpQkFBbUI7QUFDOUUsdUJBQVFGLFVBQVIsRUFBb0JDLGlCQUFwQjtBQUVBLE1BQU1FLGFBQWEsR0FBR0MscUNBQXFDLENBQUMsSUFBRCxFQUFP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LENBQUNwQixZQUFSLENBQXFCTCxJQUFyQixFQUEyQkMsS0FBM0I7QUFDRDtBQUNGLEdBTk0sTUFNQTtBQUNMd0IsSUFBQUEsT0FBTyxDQUFDcEIsWUFBUixDQUFxQkwsSUFBckIsRUFBMkJDLEtBQTNCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTQyxhQUFULENBQXVCRixJQUF2QixFQUE2QjtBQUMzQixTQUFPQSxJQUFJLENBQUNpQyxLQUFMLENBQVcsS0FBWCxDQUFQO0FBQ0Q7O0FBRUQsU0FBUzdCLGVBQVQsQ0FBeUJKLElBQXpCLEVBQStCUixHQUEvQixFQUFvQztBQUNsQyxTQUFPQSxHQUFHLEdBQUcsOEJBQW1CUSxJQUFuQixDQUFILEdBQThCLCtCQUFvQkEsSUFBcEIsQ0FBeEM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBjb21iaW5lLCBwcnVuZSB9IGZyb20gXCIuLi91dGlsaXRpZXMvb2JqZWN0XCI7XG5pbXBvcnQgeyBmaXJzdCwgZ3VhcmFudGVlIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9hcnJheVwiO1xuaW1wb3J0IHsgU1ZHX05BTUVTUEFDRV9VUkkgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBpc0hUTUxBdHRyaWJ1dGVOYW1lLCBpc1NWR0F0dHJpYnV0ZU5hbWUgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL25hbWVcIjtcbmltcG9ydCB7IHJlbW92ZUZhbHNleUVsZW1lbnRzLCByZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2VsZW1lbnRzXCI7XG5cbmZ1bmN0aW9uIGFwcGx5UHJvcGVydGllcyhwcm9wZXJ0aWVzID0ge30sIGRlZmF1bHRQcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcykge1xuICBjb21iaW5lKHByb3BlcnRpZXMsIGRlZmF1bHRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBjaGlsZEVsZW1lbnRzID0gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyh0aGlzLCBwcm9wZXJ0aWVzKSB8fCBwcm9wZXJ0aWVzLmNoaWxkRWxlbWVudHM7ICAvLy9cblxuICBwcnVuZShwcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcyk7XG5cbiAgY29uc3Qgc3ZnID0gKHRoaXMuZG9tRWxlbWVudC5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0VfVVJJKSwgLy8vXG4gICAgICAgIG5hbWVzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7ICAvLy9cblxuICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSBwcm9wZXJ0aWVzW25hbWVdO1xuXG4gICAgaWYgKGZhbHNlKSB7XG4gICAgICAvLy9cbiAgICB9IGVsc2UgaWYgKGlzSGFuZGxlck5hbWUobmFtZSkpIHtcbiAgICAgIGFkZEhhbmRsZXIodGhpcywgbmFtZSwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoaXNBdHRyaWJ1dGVOYW1lKG5hbWUsIHN2ZykpIHtcbiAgICAgIGFkZEF0dHJpYnV0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShcInByb3BlcnRpZXNcIikpIHtcbiAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IHt9O1xuXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgICAgIHByb3BlcnRpZXNcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMucHJvcGVydGllc1tuYW1lXSA9IHZhbHVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgY29udGV4dCA9IHt9O1xuXG4gIGNoaWxkRWxlbWVudHMuZm9yRWFjaCgoY2hpbGRFbGVtZW50KSA9PiB7XG4gICAgdXBkYXRlQ29udGV4dChjaGlsZEVsZW1lbnQsIGNvbnRleHQpO1xuXG4gICAgY2hpbGRFbGVtZW50LmFkZFRvKHRoaXMpO1xuICB9KTtcblxuICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICBjb250ZXh0XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKCkge1xuICByZXR1cm4gdGhpcy5wcm9wZXJ0aWVzO1xufVxuXG5mdW5jdGlvbiBnZXRDb250ZXh0KCkge1xuICByZXR1cm4gdGhpcy5jb250ZXh0O1xufVxuXG5mdW5jdGlvbiBhc3NpZ25Db250ZXh0KG5hbWVzLCB0aGVuRGVsZXRlKSB7XG4gIGNvbnN0IGFyZ3VtZW50c0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7XG5cbiAgaWYgKGFyZ3VtZW50c0xlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IGZpcnN0QXJndW1lbnQgPSBmaXJzdChhcmd1bWVudHMpO1xuXG4gICAgaWYgKHR5cGVvZiBmaXJzdEFyZ3VtZW50ID09PSBcImJvb2xlYW5cIikge1xuICAgICAgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHQpO1xuXG4gICAgICB0aGVuRGVsZXRlID0gZmlyc3RBcmd1bWVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhlbkRlbGV0ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgaWYgKGFyZ3VtZW50c0xlbmd0aCA9PT0gMCkge1xuICAgIG5hbWVzID0gT2JqZWN0LmtleXModGhpcy5jb250ZXh0KTtcblxuICAgIHRoZW5EZWxldGUgPSB0cnVlO1xuICB9XG5cbiAgbmFtZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jb250ZXh0W25hbWVdLFxuICAgICAgICAgIHByb3BlcnR5TmFtZSA9IG5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjcmlwdG9yID0ge1xuICAgICAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICAgICAgfTtcblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIGRlc2NyaXB0b3IpO1xuXG4gICAgaWYgKHRoZW5EZWxldGUpIHtcbiAgICAgIGRlbGV0ZSB0aGlzLmNvbnRleHRbbmFtZV07XG4gICAgfVxuICB9LCBbXSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBhcHBseVByb3BlcnRpZXMsXG4gIGdldFByb3BlcnRpZXMsXG4gIGdldENvbnRleHQsXG4gIGFzc2lnbkNvbnRleHRcbn07XG5cbmZ1bmN0aW9uIGNoaWxkRWxlbWVudHNGcm9tRWxlbWVudEFuZFByb3BlcnRpZXMoZWxlbWVudCwgcHJvcGVydGllcykge1xuICBsZXQgY2hpbGRFbGVtZW50cyA9IG51bGw7XG5cbiAgaWYgKHR5cGVvZiBlbGVtZW50LmNoaWxkRWxlbWVudHMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIGNoaWxkRWxlbWVudHMgPSBlbGVtZW50LmNoaWxkRWxlbWVudHMocHJvcGVydGllcyk7XG5cbiAgICBjaGlsZEVsZW1lbnRzID0gZ3VhcmFudGVlKGNoaWxkRWxlbWVudHMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlbW92ZUZhbHNleUVsZW1lbnRzKGNoaWxkRWxlbWVudHMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlcGxhY2VTdHJpbmdzV2l0aFRleHRFbGVtZW50cyhjaGlsZEVsZW1lbnRzKTtcbiAgfVxuXG4gIHJldHVybiBjaGlsZEVsZW1lbnRzO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCkge1xuICBjb25zdCBwYXJlbnRDb250ZXh0ID0gKHR5cGVvZiBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCA9PT0gXCJmdW5jdGlvblwiKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudC5wYXJlbnRDb250ZXh0KCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudC5jb250ZXh0OyAvLy9cblxuICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHBhcmVudENvbnRleHQpO1xuXG4gIGRlbGV0ZSBjaGlsZEVsZW1lbnQuY29udGV4dDtcbn1cblxuZnVuY3Rpb24gYWRkSGFuZGxlcihlbGVtZW50LCBuYW1lLCB2YWx1ZSkge1xuICBjb25zdCBldmVudFR5cGUgPSBuYW1lLnN1YnN0cigyKS50b0xvd2VyQ2FzZSgpLCAvLy9cbiAgICAgICAgaGFuZGxlciA9IHZhbHVlOyAgLy8vXG5cbiAgZWxlbWVudC5vbihldmVudFR5cGUsIGhhbmRsZXIpO1xufVxuXG5mdW5jdGlvbiBhZGRBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHtcbiAgaWYgKG5hbWUgPT09IFwiY2xhc3NOYW1lXCIpIHtcbiAgICBuYW1lID0gXCJjbGFzc1wiO1xuICB9XG5cbiAgaWYgKG5hbWUgPT09IFwiaHRtbEZvclwiKSB7XG4gICAgbmFtZSA9IFwiZm9yXCI7XG4gIH1cblxuICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiKSB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTtcblxuICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgIGVsZW1lbnQuZG9tRWxlbWVudFtuYW1lXVtrZXldID0gdmFsdWVba2V5XTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB2YWx1ZSA9IG5hbWU7IC8vL1xuXG4gICAgICBlbGVtZW50LmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGVsZW1lbnQuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0hhbmRsZXJOYW1lKG5hbWUpIHtcbiAgcmV0dXJuIG5hbWUubWF0Y2goL15vbi8pO1xufVxuXG5mdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWUobmFtZSwgc3ZnKSB7XG4gIHJldHVybiBzdmcgPyBpc1NWR0F0dHJpYnV0ZU5hbWUobmFtZSkgOiBpc0hUTUxBdHRyaWJ1dGVOYW1lKG5hbWUpXG59XG4iXX0=