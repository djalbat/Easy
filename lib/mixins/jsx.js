"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var constants = require("../constants"),
    nameUtilities = require("../utilities/name"),
    arrayUtilities = require("../utilities/array"),
    objectUtilities = require("../utilities/object"),
    elementsUtilities = require("../utilities/elements");

var combine = objectUtilities.combine,
    prune = objectUtilities.prune,
    first = arrayUtilities.first,
    guarantee = arrayUtilities.guarantee,
    SVG_NAMESPACE_URI = constants.SVG_NAMESPACE_URI,
    isHTMLAttributeName = nameUtilities.isHTMLAttributeName,
    isSVGAttributeName = nameUtilities.isSVGAttributeName,
    removeFalseyElements = elementsUtilities.removeFalseyElements,
    replaceStringsWithTextElements = elementsUtilities.replaceStringsWithTextElements;

function applyProperties() {
  var _this = this;

  var properties = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var defaultProperties = arguments.length > 1 ? arguments[1] : undefined;
  var ignoredProperties = arguments.length > 2 ? arguments[2] : undefined;
  combine(properties, defaultProperties);
  var childElements = childElementsFromElementAndProperties(this, properties) || properties.childElements; ///

  prune(properties, ignoredProperties);
  var svg = this.domElement.namespaceURI === SVG_NAMESPACE_URI,
      ///
  names = Object.keys(properties); ///

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {///
    } else if (isHandlerName(name)) {
      addHandler(_this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(_this, name, value);
    } else {
      if (!_this.hasOwnProperty("properties")) {
        var _properties = {};
        Object.assign(_this, {
          properties: _properties
        });
      }

      _this.properties[name] = value;
    }
  });
  var context = {};
  childElements.forEach(function (childElement) {
    updateContext(childElement, context);
    childElement.addTo(_this);
  });
  Object.assign(this, {
    context: context
  });
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function assignContext(names, thenDelete) {
  var _this2 = this;

  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = first(arguments);

    if (typeof firstArgument === "boolean") {
      names = Object.keys(this.context);
      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);
    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = _this2.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };
    Object.defineProperty(_this2, propertyName, descriptor);

    if (thenDelete) {
      delete _this2.context[name];
    }
  }, []);
}

module.exports = {
  applyProperties: applyProperties,
  getProperties: getProperties,
  getContext: getContext,
  assignContext: assignContext
};

function childElementsFromElementAndProperties(element, properties) {
  var childElements = null;

  if (typeof element.childElements === "function") {
    childElements = element.childElements(properties);
    childElements = guarantee(childElements);
    childElements = removeFalseyElements(childElements);
    childElements = replaceStringsWithTextElements(childElements);
  }

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === "function" ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);
  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === "className") {
    name = "class";
  }

  if (name === "htmlFor") {
    name = "for";
  }

  if (_typeof(value) === "object") {
    var keys = Object.keys(value);
    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    });
  } else if (typeof value === "boolean") {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? isSVGAttributeName(name) : isHTMLAttributeName(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzeC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJyZXF1aXJlIiwibmFtZVV0aWxpdGllcyIsImFycmF5VXRpbGl0aWVzIiwib2JqZWN0VXRpbGl0aWVzIiwiZWxlbWVudHNVdGlsaXRpZXMiLCJjb21iaW5lIiwicHJ1bmUiLCJmaXJzdCIsImd1YXJhbnRlZSIsIlNWR19OQU1FU1BBQ0VfVVJJIiwiaXNIVE1MQXR0cmlidXRlTmFtZSIsImlzU1ZHQXR0cmlidXRlTmFtZSIsInJlbW92ZUZhbHNleUVsZW1lbnRzIiwicmVwbGFjZVN0cmluZ3NXaXRoVGV4dEVsZW1lbnRzIiwiYXBwbHlQcm9wZXJ0aWVzIiwicHJvcGVydGllcyIsImRlZmF1bHRQcm9wZXJ0aWVzIiwiaWdub3JlZFByb3BlcnRpZXMiLCJjaGlsZEVsZW1lbnRzIiwiY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyIsInN2ZyIsImRvbUVsZW1lbnQiLCJuYW1lc3BhY2VVUkkiLCJuYW1lcyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwibmFtZSIsInZhbHVlIiwiaXNIYW5kbGVyTmFtZSIsImFkZEhhbmRsZXIiLCJpc0F0dHJpYnV0ZU5hbWUiLCJhZGRBdHRyaWJ1dGUiLCJoYXNPd25Qcm9wZXJ0eSIsImFzc2lnbiIsImNvbnRleHQiLCJjaGlsZEVsZW1lbnQiLCJ1cGRhdGVDb250ZXh0IiwiYWRkVG8iLCJnZXRQcm9wZXJ0aWVzIiwiZ2V0Q29udGV4dCIsImFzc2lnbkNvbnRleHQiLCJ0aGVuRGVsZXRlIiwiYXJndW1lbnRzTGVuZ3RoIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiZmlyc3RBcmd1bWVudCIsInByb3BlcnR5TmFtZSIsImRlc2NyaXB0b3IiLCJkZWZpbmVQcm9wZXJ0eSIsIm1vZHVsZSIsImV4cG9ydHMiLCJlbGVtZW50IiwicGFyZW50Q29udGV4dCIsImV2ZW50VHlwZSIsInN1YnN0ciIsInRvTG93ZXJDYXNlIiwiaGFuZGxlciIsIm9uIiwia2V5Iiwi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Q2lDLEtBQUwsQ0FBVyxLQUFYLENBQVA7QUFDRDs7QUFFRCxTQUFTN0IsZUFBVCxDQUF5QkosSUFBekIsRUFBK0JQLEdBQS9CLEVBQW9DO0FBQ2xDLFNBQU9BLEdBQUcsR0FBR1Qsa0JBQWtCLENBQUNnQixJQUFELENBQXJCLEdBQThCakIsbUJBQW1CLENBQUNpQixJQUFELENBQTNEO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZShcIi4uL2NvbnN0YW50c1wiKSxcbiAgICAgIG5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKFwiLi4vdXRpbGl0aWVzL25hbWVcIiksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvYXJyYXlcIiksXG4gICAgICBvYmplY3RVdGlsaXRpZXMgPSByZXF1aXJlKFwiLi4vdXRpbGl0aWVzL29iamVjdFwiKSxcbiAgICAgIGVsZW1lbnRzVXRpbGl0aWVzID0gcmVxdWlyZShcIi4uL3V0aWxpdGllcy9lbGVtZW50c1wiKTtcblxuY29uc3QgeyBjb21iaW5lLCBwcnVuZSB9ID0gb2JqZWN0VXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZ3VhcmFudGVlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgU1ZHX05BTUVTUEFDRV9VUkkgfSA9IGNvbnN0YW50cyxcbiAgICAgIHsgaXNIVE1MQXR0cmlidXRlTmFtZSwgaXNTVkdBdHRyaWJ1dGVOYW1lIH0gPSBuYW1lVXRpbGl0aWVzLFxuICAgICAgeyByZW1vdmVGYWxzZXlFbGVtZW50cywgcmVwbGFjZVN0cmluZ3NXaXRoVGV4dEVsZW1lbnRzIH0gPSBlbGVtZW50c1V0aWxpdGllcztcblxuZnVuY3Rpb24gYXBwbHlQcm9wZXJ0aWVzKHByb3BlcnRpZXMgPSB7fSwgZGVmYXVsdFByb3BlcnRpZXMsIGlnbm9yZWRQcm9wZXJ0aWVzKSB7XG4gIGNvbWJpbmUocHJvcGVydGllcywgZGVmYXVsdFByb3BlcnRpZXMpO1xuXG4gIGNvbnN0IGNoaWxkRWxlbWVudHMgPSBjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzKHRoaXMsIHByb3BlcnRpZXMpIHx8IHByb3BlcnRpZXMuY2hpbGRFbGVtZW50czsgIC8vL1xuXG4gIHBydW5lKHByb3BlcnRpZXMsIGlnbm9yZWRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBzdmcgPSAodGhpcy5kb21FbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRV9VUkkpLCAvLy9cbiAgICAgICAgbmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsgIC8vL1xuXG4gIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IHByb3BlcnRpZXNbbmFtZV07XG5cbiAgICBpZiAoZmFsc2UpIHtcbiAgICAgIC8vL1xuICAgIH0gZWxzZSBpZiAoaXNIYW5kbGVyTmFtZShuYW1lKSkge1xuICAgICAgYWRkSGFuZGxlcih0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChpc0F0dHJpYnV0ZU5hbWUobmFtZSwgc3ZnKSkge1xuICAgICAgYWRkQXR0cmlidXRlKHRoaXMsIG5hbWUsIHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KFwicHJvcGVydGllc1wiKSkge1xuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0ge307XG5cbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICAgICAgcHJvcGVydGllc1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5wcm9wZXJ0aWVzW25hbWVdID0gdmFsdWU7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBjb250ZXh0ID0ge307XG5cbiAgY2hpbGRFbGVtZW50cy5mb3JFYWNoKChjaGlsZEVsZW1lbnQpID0+IHtcbiAgICB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCk7XG5cbiAgICBjaGlsZEVsZW1lbnQuYWRkVG8odGhpcyk7XG4gIH0pO1xuXG4gIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgIGNvbnRleHRcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFByb3BlcnRpZXMoKSB7XG4gIHJldHVybiB0aGlzLnByb3BlcnRpZXM7XG59XG5cbmZ1bmN0aW9uIGdldENvbnRleHQoKSB7XG4gIHJldHVybiB0aGlzLmNvbnRleHQ7XG59XG5cbmZ1bmN0aW9uIGFzc2lnbkNvbnRleHQobmFtZXMsIHRoZW5EZWxldGUpIHtcbiAgY29uc3QgYXJndW1lbnRzTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDtcblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgZmlyc3RBcmd1bWVudCA9IGZpcnN0KGFyZ3VtZW50cyk7XG5cbiAgICBpZiAodHlwZW9mIGZpcnN0QXJndW1lbnQgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICBuYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuY29udGV4dCk7XG5cbiAgICAgIHRoZW5EZWxldGUgPSBmaXJzdEFyZ3VtZW50O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGVuRGVsZXRlID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAwKSB7XG4gICAgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHQpO1xuXG4gICAgdGhlbkRlbGV0ZSA9IHRydWU7XG4gIH1cblxuICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvbnRleHRbbmFtZV0sXG4gICAgICAgICAgcHJvcGVydHlOYW1lID0gbmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NyaXB0b3IgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICB9O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgZGVzY3JpcHRvcik7XG5cbiAgICBpZiAodGhlbkRlbGV0ZSkge1xuICAgICAgZGVsZXRlIHRoaXMuY29udGV4dFtuYW1lXTtcbiAgICB9XG4gIH0sIFtdKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGFwcGx5UHJvcGVydGllcyxcbiAgZ2V0UHJvcGVydGllcyxcbiAgZ2V0Q29udGV4dCxcbiAgYXNzaWduQ29udGV4dFxufTtcblxuZnVuY3Rpb24gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyhlbGVtZW50LCBwcm9wZXJ0aWVzKSB7XG4gIGxldCBjaGlsZEVsZW1lbnRzID0gbnVsbDtcblxuICBpZiAodHlwZW9mIGVsZW1lbnQuY2hpbGRFbGVtZW50cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgY2hpbGRFbGVtZW50cyA9IGVsZW1lbnQuY2hpbGRFbGVtZW50cyhwcm9wZXJ0aWVzKTtcblxuICAgIGNoaWxkRWxlbWVudHMgPSBndWFyYW50ZWUoY2hpbGRFbGVtZW50cyk7XG5cbiAgICBjaGlsZEVsZW1lbnRzID0gcmVtb3ZlRmFsc2V5RWxlbWVudHMoY2hpbGRFbGVtZW50cyk7XG5cbiAgICBjaGlsZEVsZW1lbnRzID0gcmVwbGFjZVN0cmluZ3NXaXRoVGV4dEVsZW1lbnRzKGNoaWxkRWxlbWVudHMpO1xuICB9XG5cbiAgcmV0dXJuIGNoaWxkRWxlbWVudHM7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUNvbnRleHQoY2hpbGRFbGVtZW50LCBjb250ZXh0KSB7XG4gIGNvbnN0IHBhcmVudENvbnRleHQgPSAodHlwZW9mIGNoaWxkRWxlbWVudC5wYXJlbnRDb250ZXh0ID09PSBcImZ1bmN0aW9uXCIpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRFbGVtZW50LnBhcmVudENvbnRleHQoKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRFbGVtZW50LmNvbnRleHQ7IC8vL1xuXG4gIE9iamVjdC5hc3NpZ24oY29udGV4dCwgcGFyZW50Q29udGV4dCk7XG5cbiAgZGVsZXRlIGNoaWxkRWxlbWVudC5jb250ZXh0O1xufVxuXG5mdW5jdGlvbiBhZGRIYW5kbGVyKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7XG4gIGNvbnN0IGV2ZW50VHlwZSA9IG5hbWUuc3Vic3RyKDIpLnRvTG93ZXJDYXNlKCksIC8vL1xuICAgICAgICBoYW5kbGVyID0gdmFsdWU7ICAvLy9cblxuICBlbGVtZW50Lm9uKGV2ZW50VHlwZSwgaGFuZGxlcik7XG59XG5cbmZ1bmN0aW9uIGFkZEF0dHJpYnV0ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSkge1xuICBpZiAobmFtZSA9PT0gXCJjbGFzc05hbWVcIikge1xuICAgIG5hbWUgPSBcImNsYXNzXCI7XG4gIH1cblxuICBpZiAobmFtZSA9PT0gXCJodG1sRm9yXCIpIHtcbiAgICBuYW1lID0gXCJmb3JcIjtcbiAgfVxuXG4gIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpO1xuXG4gICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xuICAgICAgZWxlbWVudC5kb21FbGVtZW50W25hbWVdW2tleV0gPSB2YWx1ZVtrZXldO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJib29sZWFuXCIpIHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHZhbHVlID0gbmFtZTsgLy8vXG5cbiAgICAgIGVsZW1lbnQuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZWxlbWVudC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzSGFuZGxlck5hbWUobmFtZSkge1xuICByZXR1cm4gbmFtZS5tYXRjaCgvXm9uLyk7XG59XG5cbmZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZShuYW1lLCBzdmcpIHtcbiAgcmV0dXJuIHN2ZyA/IGlzU1ZHQXR0cmlidXRlTmFtZShuYW1lKSA6IGlzSFRNTEF0dHJpYnV0ZU5hbWUobmFtZSlcbn1cbiJdfQ==