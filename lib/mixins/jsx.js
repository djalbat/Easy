"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.applyProperties = applyProperties;
exports.getProperties = getProperties;
exports.getContext = getContext;
exports.assignContext = assignContext;

var _object = require("../utilities/object");

var _array = require("../utilities/array");

var _constants = require("../constants");

var _name = require("../utilities/name");

var _elements = require("../utilities/elements");

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function applyProperties(properties, defaultProperties, ignoredProperties) {
  var _this = this;

  properties = Object.assign({}, properties); ///

  (0, _object.combine)(properties, defaultProperties);
  var childElements = childElementsFromElementAndProperties(this, properties) || properties.childElements; ///

  (0, _object.prune)(properties, ignoredProperties);
  var svg = this.domElement.namespaceURI === _constants.SVG_NAMESPACE_URI,
      ///
  names = Object.keys(properties); ///

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {///
    } else if (isHandlerName(name)) {
      addHandler(_this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(_this, name, value);
    } else {
      if (!_this.hasOwnProperty("properties")) {
        var _properties = {};
        Object.assign(_this, {
          properties: _properties
        });
      }

      _this.properties[name] = value;
    }
  });
  var context = {};
  childElements.forEach(function (childElement) {
    updateContext(childElement, context);
    childElement.addTo(_this);
  });
  Object.assign(this, {
    context: context
  });
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function assignContext(names, thenDelete) {
  var _this2 = this;

  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = (0, _array.first)(arguments);

    if (typeof firstArgument === "boolean") {
      names = Object.keys(this.context);
      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);
    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = _this2.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };
    Object.defineProperty(_this2, propertyName, descriptor);

    if (thenDelete) {
      delete _this2.context[name];
    }
  }, []);
}

function childElementsFromElementAndProperties(element, properties) {
  var childElements = null;

  if (typeof element.childElements === "function") {
    childElements = element.childElements.call(element, properties);
    childElements = (0, _array.guarantee)(childElements);
    childElements = (0, _elements.removeFalseyElements)(childElements);
    childElements = (0, _elements.replaceStringsWithTextElements)(childElements);
  }

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === "function" ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);
  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === "className") {
    name = "class";
  }

  if (name === "htmlFor") {
    name = "for";
  }

  if (_typeof(value) === "object") {
    var keys = Object.keys(value);
    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    });
  } else if (typeof value === "boolean") {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? (0, _name.isSVGAttributeName)(name) : (0, _name.isHTMLAttributeName)(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzeC5qcyJdLCJuYW1lcyI6WyJhcHBseVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZGVmYXVsdFByb3BlcnRpZXMiLCJpZ25vcmVkUHJvcGVydGllcyIsIk9iamVjdCIsImFzc2lnbiIsImNoaWxkRWxlbWVudHMiLCJjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzIiwic3ZnIiwiZG9tRWxlbWVudCIsIm5hbWVzcGFjZVVSSSIsIlNWR19OQU1FU1BBQ0VfVVJJIiwibmFtZXMiLCJrZXlzIiwiZm9yRWFjaCIsIm5hbWUiLCJ2YWx1ZSIsImlzSGFuZGxlck5hbWUiLCJhZGRIYW5kbGVyIiwiaXNBdHRyaWJ1dGVOYW1lIiwiYWRkQXR0cmlidXRlIiwiaGFzT3duUHJvcGVydHkiLCJjb250ZXh0IiwiY2hpbGRFbGVtZW50IiwidXBkYXRlQ29udGV4dCIsImFkZFRvIiwiZ2V0UHJvcGVydGllcyIsImdldENvbnRleHQiLCJhc3NpZ25Db250ZXh0IiwidGhlbkRlbGV0ZSIsImFyZ3VtZW50c0xlbmd0aCIsImFyZ3VtZW50cyIsImxlbmd0aCIsImZpcnN0QXJndW1lbnQiLCJwcm9wZXJ0eU5hbWUiLCJkZXNjcmlwdG9yIiwiZGVmaW5lUHJvcGVydHkiLCJlbGVtZW50IiwiY2FsbCIsInBhcmVudENvbnRleHQiLCJldmVudFR5cGUiLCJzdWJzdHIiLCJ0b0xvd2VyQ2FzZSIsImhhbmRsZXIiLCJvbiIsImtleSIsIm1hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRU8sU0FBU0EsZUFBVCxDQUF5QkMsVUFBekIsRUFBcUNDLGlCQUFyQyxFQUF3REMsaUJBQXhELEVBQTJFO0FBQUE7O0FBQ2hGRixFQUFBQSxVQUFVLEdBQUdHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JKLFVBQWxCLENBQWIsQ0FEZ0YsQ0FDcEM7O0FBRTVDLHVCQUFRQSxVQUFSLEVBQW9CQyxp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LE9BQU8sQ0FBQ2pCLFlBQVIsQ0FBcUJMLElBQXJCLEVBQTJCQyxLQUEzQjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU0MsYUFBVCxDQUF1QkYsSUFBdkIsRUFBNkI7QUFDM0IsU0FBT0EsSUFBSSxDQUFDK0IsS0FBTCxDQUFXLEtBQVgsQ0FBUDtBQUNEOztBQUVELFNBQVMzQixlQUFULENBQXlCSixJQUF6QixFQUErQlAsR0FBL0IsRUFBb0M7QUFDbEMsU0FBT0EsR0FBRyxHQUFHLDhCQUFtQk8sSUFBbkIsQ0FBSCxHQUE4QiwrQkFBb0JBLElBQXBCLENBQXhDO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHsgY29tYmluZSwgcHJ1bmUgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL29iamVjdFwiO1xuaW1wb3J0IHsgZmlyc3QsIGd1YXJhbnRlZSB9IGZyb20gXCIuLi91dGlsaXRpZXMvYXJyYXlcIjtcbmltcG9ydCB7IFNWR19OQU1FU1BBQ0VfVVJJIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuaW1wb3J0IHsgaXNIVE1MQXR0cmlidXRlTmFtZSwgaXNTVkdBdHRyaWJ1dGVOYW1lIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9uYW1lXCI7XG5pbXBvcnQgeyByZW1vdmVGYWxzZXlFbGVtZW50cywgcmVwbGFjZVN0cmluZ3NXaXRoVGV4dEVsZW1lbnRzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9lbGVtZW50c1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gYXBwbHlQcm9wZXJ0aWVzKHByb3BlcnRpZXMsIGRlZmF1bHRQcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcykge1xuICBwcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvcGVydGllcyk7IC8vL1xuXG4gIGNvbWJpbmUocHJvcGVydGllcywgZGVmYXVsdFByb3BlcnRpZXMpO1xuXG4gIGNvbnN0IGNoaWxkRWxlbWVudHMgPSBjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzKHRoaXMsIHByb3BlcnRpZXMpIHx8IHByb3BlcnRpZXMuY2hpbGRFbGVtZW50czsgIC8vL1xuXG4gIHBydW5lKHByb3BlcnRpZXMsIGlnbm9yZWRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBzdmcgPSAodGhpcy5kb21FbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRV9VUkkpLCAvLy9cbiAgICAgICAgbmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsgIC8vL1xuXG4gIG5hbWVzLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IHByb3BlcnRpZXNbbmFtZV07XG5cbiAgICBpZiAoZmFsc2UpIHtcbiAgICAgIC8vL1xuICAgIH0gZWxzZSBpZiAoaXNIYW5kbGVyTmFtZShuYW1lKSkge1xuICAgICAgYWRkSGFuZGxlcih0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChpc0F0dHJpYnV0ZU5hbWUobmFtZSwgc3ZnKSkge1xuICAgICAgYWRkQXR0cmlidXRlKHRoaXMsIG5hbWUsIHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KFwicHJvcGVydGllc1wiKSkge1xuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0ge307XG5cbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICAgICAgcHJvcGVydGllc1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5wcm9wZXJ0aWVzW25hbWVdID0gdmFsdWU7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBjb250ZXh0ID0ge307XG5cbiAgY2hpbGRFbGVtZW50cy5mb3JFYWNoKChjaGlsZEVsZW1lbnQpID0+IHtcbiAgICB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCk7XG5cbiAgICBjaGlsZEVsZW1lbnQuYWRkVG8odGhpcyk7XG4gIH0pO1xuXG4gIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgIGNvbnRleHRcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKCkge1xuICByZXR1cm4gdGhpcy5wcm9wZXJ0aWVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHtcbiAgcmV0dXJuIHRoaXMuY29udGV4dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc2lnbkNvbnRleHQobmFtZXMsIHRoZW5EZWxldGUpIHtcbiAgY29uc3QgYXJndW1lbnRzTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDtcblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgZmlyc3RBcmd1bWVudCA9IGZpcnN0KGFyZ3VtZW50cyk7XG5cbiAgICBpZiAodHlwZW9mIGZpcnN0QXJndW1lbnQgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICBuYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuY29udGV4dCk7XG5cbiAgICAgIHRoZW5EZWxldGUgPSBmaXJzdEFyZ3VtZW50O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGVuRGVsZXRlID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAwKSB7XG4gICAgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHQpO1xuXG4gICAgdGhlbkRlbGV0ZSA9IHRydWU7XG4gIH1cblxuICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvbnRleHRbbmFtZV0sXG4gICAgICAgICAgcHJvcGVydHlOYW1lID0gbmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NyaXB0b3IgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICB9O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgZGVzY3JpcHRvcik7XG5cbiAgICBpZiAodGhlbkRlbGV0ZSkge1xuICAgICAgZGVsZXRlIHRoaXMuY29udGV4dFtuYW1lXTtcbiAgICB9XG4gIH0sIFtdKTtcbn1cblxuZnVuY3Rpb24gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyhlbGVtZW50LCBwcm9wZXJ0aWVzKSB7XG4gIGxldCBjaGlsZEVsZW1lbnRzID0gbnVsbDtcblxuICBpZiAodHlwZW9mIGVsZW1lbnQuY2hpbGRFbGVtZW50cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgY2hpbGRFbGVtZW50cyA9IGVsZW1lbnQuY2hpbGRFbGVtZW50cy5jYWxsKGVsZW1lbnQsIHByb3BlcnRpZXMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IGd1YXJhbnRlZShjaGlsZEVsZW1lbnRzKTtcblxuICAgIGNoaWxkRWxlbWVudHMgPSByZW1vdmVGYWxzZXlFbGVtZW50cyhjaGlsZEVsZW1lbnRzKTtcblxuICAgIGNoaWxkRWxlbWVudHMgPSByZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMoY2hpbGRFbGVtZW50cyk7XG4gIH1cblxuICByZXR1cm4gY2hpbGRFbGVtZW50cztcbn1cblxuZnVuY3Rpb24gdXBkYXRlQ29udGV4dChjaGlsZEVsZW1lbnQsIGNvbnRleHQpIHtcbiAgY29uc3QgcGFyZW50Q29udGV4dCA9ICh0eXBlb2YgY2hpbGRFbGVtZW50LnBhcmVudENvbnRleHQgPT09IFwiZnVuY3Rpb25cIikgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCgpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQuY29udGV4dDsgLy8vXG5cbiAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCBwYXJlbnRDb250ZXh0KTtcblxuICBkZWxldGUgY2hpbGRFbGVtZW50LmNvbnRleHQ7XG59XG5cbmZ1bmN0aW9uIGFkZEhhbmRsZXIoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHtcbiAgY29uc3QgZXZlbnRUeXBlID0gbmFtZS5zdWJzdHIoMikudG9Mb3dlckNhc2UoKSwgLy8vXG4gICAgICAgIGhhbmRsZXIgPSB2YWx1ZTsgIC8vL1xuXG4gIGVsZW1lbnQub24oZXZlbnRUeXBlLCBoYW5kbGVyKTtcbn1cblxuZnVuY3Rpb24gYWRkQXR0cmlidXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7XG4gIGlmIChuYW1lID09PSBcImNsYXNzTmFtZVwiKSB7XG4gICAgbmFtZSA9IFwiY2xhc3NcIjtcbiAgfVxuXG4gIGlmIChuYW1lID09PSBcImh0bWxGb3JcIikge1xuICAgIG5hbWUgPSBcImZvclwiO1xuICB9XG5cbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7XG5cbiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgZWxlbWVudC5kb21FbGVtZW50W25hbWVdW2tleV0gPSB2YWx1ZVtrZXldO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJib29sZWFuXCIpIHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHZhbHVlID0gbmFtZTsgLy8vXG5cbiAgICAgIGVsZW1lbnQuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZWxlbWVudC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzSGFuZGxlck5hbWUobmFtZSkge1xuICByZXR1cm4gbmFtZS5tYXRjaCgvXm9uLyk7XG59XG5cbmZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZShuYW1lLCBzdmcpIHtcbiAgcmV0dXJuIHN2ZyA/IGlzU1ZHQXR0cmlidXRlTmFtZShuYW1lKSA6IGlzSFRNTEF0dHJpYnV0ZU5hbWUobmFtZSlcbn1cbiJdfQ==