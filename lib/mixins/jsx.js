'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var constants = require('../constants'),
    nameUtilities = require('../utilities/name'),
    arrayUtilities = require('../utilities/array'),
    objectUtilities = require('../utilities/object'),
    elementsUtilities = require('../utilities/elements');

var combine = objectUtilities.combine,
    prune = objectUtilities.prune,
    first = arrayUtilities.first,
    guarantee = arrayUtilities.guarantee,
    SVG_NAMESPACE_URI = constants.SVG_NAMESPACE_URI,
    isHTMLAttributeName = nameUtilities.isHTMLAttributeName,
    isSVGAttributeName = nameUtilities.isSVGAttributeName,
    removeFalseyElements = elementsUtilities.removeFalseyElements,
    replaceStringsWithTextElements = elementsUtilities.replaceStringsWithTextElements;


function applyProperties() {
  var properties = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  var _this = this;

  var defaultProperties = arguments[1];
  var ignoredProperties = arguments[2];

  combine(properties, defaultProperties);

  var childElements = childElementsFromElementAndProperties(this, properties) || properties.childElements; ///

  prune(properties, ignoredProperties);

  var svg = this.domElement.namespaceURI === SVG_NAMESPACE_URI,
      ///
  names = Object.keys(properties); ///

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {
      ///
    } else if (isHandlerName(name)) {
      addHandler(_this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(_this, name, value);
    } else {
      if (!_this.hasOwnProperty('properties')) {
        var _properties = {};

        Object.assign(_this, {
          properties: _properties
        });
      }

      _this.properties[name] = value;
    }
  });

  var context = {};

  childElements.forEach(function (childElement) {
    updateContext(childElement, context);

    childElement.addTo(_this);
  });

  Object.assign(this, {
    context: context
  });
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function assignContext(names, thenDelete) {
  var _this2 = this;

  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = first(arguments);

    if (typeof firstArgument === 'boolean') {
      names = Object.keys(this.context);

      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);

    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = _this2.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };

    Object.defineProperty(_this2, propertyName, descriptor);

    if (thenDelete) {
      delete _this2.context[name];
    }
  }, []);
}

module.exports = {
  applyProperties: applyProperties,
  getProperties: getProperties,
  getContext: getContext,
  assignContext: assignContext
};

function childElementsFromElementAndProperties(element, properties) {
  var childElements = null;

  if (typeof element.childElements === 'function') {
    childElements = element.childElements(properties);

    childElements = guarantee(childElements);

    childElements = removeFalseyElements(childElements);

    childElements = replaceStringsWithTextElements(childElements);
  }

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === 'function' ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);

  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === 'className') {
    name = 'class';
  }

  if (name === 'htmlFor') {
    name = 'for';
  }

  if ((typeof value === 'undefined' ? 'undefined' : _typeof(value)) === 'object') {
    var keys = Object.keys(value);

    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    });
  } else if (typeof value === 'boolean') {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? isSVGAttributeName(name) : isHTMLAttributeName(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9taXhpbnMvanN4LmpzIl0sIm5hbWVzIjpbImNvbnN0YW50cyIsInJlcXVpcmUiLCJuYW1lVXRpbGl0aWVzIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJlbGVtZW50c1V0aWxpdGllcyIsImNvbWJpbmUiLCJwcnVuZSIsImZpcnN0IiwiZ3VhcmFudGVlIiwiU1ZHX05BTUVTUEFDRV9VUkkiLCJpc0hUTUxBdHRyaWJ1dGVOYW1lIiwiaXNTVkdBdHRyaWJ1dGVOYW1lIiwicmVtb3ZlRmFsc2V5RWxlbWVudHMiLCJyZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMiLCJhcHBseVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZGVmYXVsdFByb3BlcnRpZXMiLCJpZ25vcmVkUHJvcGVydGllcyIsImNoaWxkRWxlbWVudHMiLCJjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzIiwic3ZnIiwiZG9tRWxlbWVudCIsIm5hbWVzcGFjZVVSSSIsIm5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJuYW1lIiwidmFsdWUiLCJpc0hhbmRsZXJOYW1lIiwiYWRkSGFuZGxlciIsImlzQXR0cmlidXRlTmFtZSIsImFkZEF0dHJpYnV0ZSIsImhhc093blByb3BlcnR5IiwiYXNzaWduIiwiY29udGV4dCIsImNoaWxkRWxlbWVudCIsInVwZGF0ZUNvbnRleHQiLCJhZGRUbyIsImdldFByb3BlcnRpZXMiLCJnZXRDb250ZXh0IiwiYXNzaWduQ29udGV4dCIsInRoZW5EZWxldGUiLCJhcmd1bWVudHNMZW5ndGgiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJmaXJzdEFyZ3VtZW50IiwicHJvcGVydHlOYW1lIiwiZGVzY3JpcHRvciIsImRlZmluZVByb3BlcnR5IiwibW9kdWxlIiwiZXhwb3J0cyIsImVsZW1lbnQiLCJwYXJlbnRDb250ZXh0IiwiZXZlbnRUeXBlIiwic3Vic3RyIiwidG9Mb3dlckNhc2UiLCJoYW5k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eUIsY0FBUXBCLFlBQVIsQ0FBcUJMLElBQXJCLEVBQTJCQyxLQUEzQjtBQUNEO0FBQ0YsR0FOTSxNQU1BO0FBQ0x3QixZQUFRcEIsWUFBUixDQUFxQkwsSUFBckIsRUFBMkJDLEtBQTNCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTQyxhQUFULENBQXVCRixJQUF2QixFQUE2QjtBQUMzQixTQUFPQSxLQUFLaUMsS0FBTCxDQUFXLEtBQVgsQ0FBUDtBQUNEOztBQUVELFNBQVM3QixlQUFULENBQXlCSixJQUF6QixFQUErQlAsR0FBL0IsRUFBb0M7QUFDbEMsU0FBT0EsTUFBTVQsbUJBQW1CZ0IsSUFBbkIsQ0FBTixHQUFpQ2pCLG9CQUFvQmlCLElBQXBCLENBQXhDO0FBQ0QiLCJmaWxlIjoianN4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuLi9jb25zdGFudHMnKSxcbiAgICAgIG5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvbmFtZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIG9iamVjdFV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9vYmplY3QnKSxcbiAgICAgIGVsZW1lbnRzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2VsZW1lbnRzJyk7XG5cbmNvbnN0IHsgY29tYmluZSwgcHJ1bmUgfSA9IG9iamVjdFV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGd1YXJhbnRlZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IFNWR19OQU1FU1BBQ0VfVVJJIH0gPSBjb25zdGFudHMsXG4gICAgICB7IGlzSFRNTEF0dHJpYnV0ZU5hbWUsIGlzU1ZHQXR0cmlidXRlTmFtZSB9ID0gbmFtZVV0aWxpdGllcyxcbiAgICAgIHsgcmVtb3ZlRmFsc2V5RWxlbWVudHMsIHJlcGxhY2VTdHJpbmdzV2l0aFRleHRFbGVtZW50cyB9ID0gZWxlbWVudHNVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGFwcGx5UHJvcGVydGllcyhwcm9wZXJ0aWVzID0ge30sIGRlZmF1bHRQcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcykge1xuICBjb21iaW5lKHByb3BlcnRpZXMsIGRlZmF1bHRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBjaGlsZEVsZW1lbnRzID0gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyh0aGlzLCBwcm9wZXJ0aWVzKSB8fCBwcm9wZXJ0aWVzLmNoaWxkRWxlbWVudHM7ICAvLy9cblxuICBwcnVuZShwcm9wZXJ0aWVzLCBpZ25vcmVkUHJvcGVydGllcyk7XG5cbiAgY29uc3Qgc3ZnID0gKHRoaXMuZG9tRWxlbWVudC5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0VfVVJJKSwgLy8vXG4gICAgICAgIG5hbWVzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7ICAvLy9cblxuICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSBwcm9wZXJ0aWVzW25hbWVdO1xuXG4gICAgaWYgKGZhbHNlKSB7XG4gICAgICAvLy9cbiAgICB9IGVsc2UgaWYgKGlzSGFuZGxlck5hbWUobmFtZSkpIHtcbiAgICAgIGFkZEhhbmRsZXIodGhpcywgbmFtZSwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoaXNBdHRyaWJ1dGVOYW1lKG5hbWUsIHN2ZykpIHtcbiAgICAgIGFkZEF0dHJpYnV0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eSgncHJvcGVydGllcycpKSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTtcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgICAgICBwcm9wZXJ0aWVzXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnByb3BlcnRpZXNbbmFtZV0gPSB2YWx1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IGNvbnRleHQgPSB7fTtcblxuICBjaGlsZEVsZW1lbnRzLmZvckVhY2goKGNoaWxkRWxlbWVudCkgPT4ge1xuICAgIHVwZGF0ZUNvbnRleHQoY2hpbGRFbGVtZW50LCBjb250ZXh0KTtcblxuICAgIGNoaWxkRWxlbWVudC5hZGRUbyh0aGlzKTtcbiAgfSk7XG5cbiAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgY29udGV4dFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJvcGVydGllcygpIHtcbiAgcmV0dXJuIHRoaXMucHJvcGVydGllcztcbn1cblxuZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHtcbiAgcmV0dXJuIHRoaXMuY29udGV4dDtcbn1cblxuZnVuY3Rpb24gYXNzaWduQ29udGV4dChuYW1lcywgdGhlbkRlbGV0ZSkge1xuICBjb25zdCBhcmd1bWVudHNMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoO1xuXG4gIGlmIChhcmd1bWVudHNMZW5ndGggPT09IDEpIHtcbiAgICBjb25zdCBmaXJzdEFyZ3VtZW50ID0gZmlyc3QoYXJndW1lbnRzKTtcblxuICAgIGlmICh0eXBlb2YgZmlyc3RBcmd1bWVudCA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICBuYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMuY29udGV4dCk7XG5cbiAgICAgIHRoZW5EZWxldGUgPSBmaXJzdEFyZ3VtZW50O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGVuRGVsZXRlID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAwKSB7XG4gICAgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHQpO1xuXG4gICAgdGhlbkRlbGV0ZSA9IHRydWU7XG4gIH1cblxuICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvbnRleHRbbmFtZV0sXG4gICAgICAgICAgcHJvcGVydHlOYW1lID0gbmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NyaXB0b3IgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICB9O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgZGVzY3JpcHRvcik7XG5cbiAgICBpZiAodGhlbkRlbGV0ZSkge1xuICAgICAgZGVsZXRlIHRoaXMuY29udGV4dFtuYW1lXTtcbiAgICB9XG4gIH0sIFtdKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGFwcGx5UHJvcGVydGllcyxcbiAgZ2V0UHJvcGVydGllcyxcbiAgZ2V0Q29udGV4dCxcbiAgYXNzaWduQ29udGV4dFxufTtcblxuZnVuY3Rpb24gY2hpbGRFbGVtZW50c0Zyb21FbGVtZW50QW5kUHJvcGVydGllcyhlbGVtZW50LCBwcm9wZXJ0aWVzKSB7XG4gIGxldCBjaGlsZEVsZW1lbnRzID0gbnVsbDtcblxuICBpZiAodHlwZW9mIGVsZW1lbnQuY2hpbGRFbGVtZW50cyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGNoaWxkRWxlbWVudHMgPSBlbGVtZW50LmNoaWxkRWxlbWVudHMocHJvcGVydGllcyk7XG5cbiAgICBjaGlsZEVsZW1lbnRzID0gZ3VhcmFudGVlKGNoaWxkRWxlbWVudHMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlbW92ZUZhbHNleUVsZW1lbnRzKGNoaWxkRWxlbWVudHMpO1xuXG4gICAgY2hpbGRFbGVtZW50cyA9IHJlcGxhY2VTdHJpbmdzV2l0aFRleHRFbGVtZW50cyhjaGlsZEVsZW1lbnRzKTtcbiAgfVxuXG4gIHJldHVybiBjaGlsZEVsZW1lbnRzO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCkge1xuICBjb25zdCBwYXJlbnRDb250ZXh0ID0gKHR5cGVvZiBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQucGFyZW50Q29udGV4dCgpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQuY29udGV4dDsgLy8vXG5cbiAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCBwYXJlbnRDb250ZXh0KTtcblxuICBkZWxldGUgY2hpbGRFbGVtZW50LmNvbnRleHQ7XG59XG5cbmZ1bmN0aW9uIGFkZEhhbmRsZXIoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHtcbiAgY29uc3QgZXZlbnRUeXBlID0gbmFtZS5zdWJzdHIoMikudG9Mb3dlckNhc2UoKSwgLy8vXG4gICAgICAgIGhhbmRsZXIgPSB2YWx1ZTsgIC8vL1xuXG4gIGVsZW1lbnQub24oZXZlbnRUeXBlLCBoYW5kbGVyKTtcbn1cblxuZnVuY3Rpb24gYWRkQXR0cmlidXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7XG4gIGlmIChuYW1lID09PSAnY2xhc3NOYW1lJykge1xuICAgIG5hbWUgPSAnY2xhc3MnO1xuICB9XG5cbiAgaWYgKG5hbWUgPT09ICdodG1sRm9yJykge1xuICAgIG5hbWUgPSAnZm9yJztcbiAgfVxuXG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTtcblxuICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgIGVsZW1lbnQuZG9tRWxlbWVudFtuYW1lXVtrZXldID0gdmFsdWVba2V5XTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykge1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdmFsdWUgPSBuYW1lOyAvLy9cblxuICAgICAgZWxlbWVudC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBlbGVtZW50LmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gaXNIYW5kbGVyTmFtZShuYW1lKSB7XG4gIHJldHVybiBuYW1lLm1hdGNoKC9eb24vKTtcbn1cblxuZnVuY3Rpb24gaXNBdHRyaWJ1dGVOYW1lKG5hbWUsIHN2Zykge1xuICByZXR1cm4gc3ZnID8gaXNTVkdBdHRyaWJ1dGVOYW1lKG5hbWUpIDogaXNIVE1MQXR0cmlidXRlTmFtZShuYW1lKVxufVxuIl19