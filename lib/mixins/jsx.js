'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var constants = require('../constants'),
    nameUtilities = require('../utilities/name'),
    arrayUtilities = require('../utilities/array'),
    objectUtilities = require('../utilities/object'),
    elementsUtilities = require('../utilities/elements');

var first = arrayUtilities.first,
    combine = objectUtilities.combine,
    prune = objectUtilities.prune,
    SVG_NAMESPACE_URI = constants.SVG_NAMESPACE_URI,
    isHTMLAttributeName = nameUtilities.isHTMLAttributeName,
    isSVGAttributeName = nameUtilities.isSVGAttributeName,
    removeFalseyElements = elementsUtilities.removeFalseyElements,
    replaceStringsWithTextElements = elementsUtilities.replaceStringsWithTextElements;


function applyProperties() {
  var properties = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var defaultProperties = arguments[1];
  var ignoredProperties = arguments[2];

  combine(properties, defaultProperties);

  var childElements = childElementsFromElementAndProperties(this, properties);

  prune(properties, ignoredProperties);

  var svg = this.domElement.namespaceURI === SVG_NAMESPACE_URI,
      names = Object.keys(properties); ///

  names.forEach(function (name) {
    var value = properties[name];

    if (false) {
      ///
    } else if (isHandlerName(name)) {
      addHandler(this, name, value);
    } else if (isAttributeName(name, svg)) {
      addAttribute(this, name, value);
    } else {
      if (!this.hasOwnProperty('properties')) {
        var _properties = {};

        Object.assign(this, {
          properties: _properties
        });
      }

      this.properties[name] = value;
    }
  }.bind(this));

  var context = {};

  childElements.forEach(function (childElement) {
    updateContext(childElement, context);

    childElement.addTo(this);
  }.bind(this));

  Object.assign(this, context);
}

function getProperties() {
  return this.properties;
}

function getContext() {
  return this.context;
}

function getState() {
  return this.state;
}

function setState(state) {
  this.state = state;
}

function updateState(update) {
  Object.assign(this.state, update);
}

function assignContext(names, thenDelete) {
  var argumentsLength = arguments.length;

  if (argumentsLength === 1) {
    var firstArgument = first(arguments);

    if (typeof firstArgument === 'boolean') {
      names = Object.keys(this.context);

      thenDelete = firstArgument;
    } else {
      thenDelete = true;
    }
  }

  if (argumentsLength === 0) {
    names = Object.keys(this.context);

    thenDelete = true;
  }

  names.forEach(function (name) {
    var value = this.context[name],
        propertyName = name,
        ///
    descriptor = {
      value: value
    };

    Object.defineProperty(this, propertyName, descriptor);

    if (thenDelete) {
      delete this.context[name];
    }
  }.bind(this), []);
}

module.exports = {
  applyProperties: applyProperties,
  getProperties: getProperties,
  getContext: getContext,
  getState: getState,
  setState: setState,
  updateState: updateState,
  assignContext: assignContext
};

function childElementsFromElementAndProperties(element, properties) {
  var childElements = typeof element.childElements === 'function' ? element.childElements(properties) : properties.childElements;

  if (!(childElements instanceof Array)) {
    childElements = [childElements];
  }

  childElements = removeFalseyElements(childElements);

  childElements = replaceStringsWithTextElements(childElements);

  return childElements;
}

function updateContext(childElement, context) {
  var parentContext = typeof childElement.parentContext === 'function' ? childElement.parentContext() : childElement.context; ///

  Object.assign(context, parentContext);

  delete childElement.context;
}

function addHandler(element, name, value) {
  var eventType = name.substr(2).toLowerCase(),
      ///
  handler = value; ///

  element.on(eventType, handler);
}

function addAttribute(element, name, value) {
  if (name === 'className') {
    name = 'class';
  }

  if (name === 'htmlFor') {
    name = 'for';
  }

  if ((typeof value === 'undefined' ? 'undefined' : _typeof(value)) === 'object') {
    var keys = Object.keys(value);

    keys.forEach(function (key) {
      element.domElement[name][key] = value[key];
    }.bind(this));
  } else if (typeof value === 'boolean') {
    if (value) {
      value = name; ///

      element.addAttribute(name, value);
    }
  } else {
    element.addAttribute(name, value);
  }
}

function isHandlerName(name) {
  return name.match(/^on/);
}

function isAttributeName(name, svg) {
  return svg ? isSVGAttributeName(name) : isHTMLAttributeName(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9taXhpbnMvanN4LmpzIl0sIm5hbWVzIjpbImNvbnN0YW50cyIsInJlcXVpcmUiLCJuYW1lVXRpbGl0aWVzIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJlbGVtZW50c1V0aWxpdGllcyIsImZpcnN0IiwiY29tYmluZSIsInBydW5lIiwiU1ZHX05BTUVTUEFDRV9VUkkiLCJpc0hUTUxBdHRyaWJ1dGVOYW1lIiwiaXNTVkdBdHRyaWJ1dGVOYW1lIiwicmVtb3ZlRmFsc2V5RWxlbWVudHMiLCJyZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMiLCJhcHBseVByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZGVmYXVsdFByb3BlcnRpZXMiLCJpZ25vcmVkUHJvcGVydGllcyIsImNoaWxkRWxlbWVudHMiLCJjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzIiwic3ZnIiwiZG9tRWxlbWVudCIsIm5hbWVzcGFjZVVSSSIsIm5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJuYW1lIiwidmFsdWUiLCJpc0hhbmRsZXJOYW1lIiwiYWRkSGFuZGxlciIsImlzQXR0cmlidXRlTmFtZSIsImFkZEF0dHJpYnV0ZSIsImhhc093blByb3BlcnR5IiwiYXNzaWduIiwiYmluZCIsImNvbnRleHQiLCJjaGlsZEVsZW1lbnQiLCJ1cGRhdGVDb250ZXh0IiwiYWRkVG8iLCJnZXRQcm9wZXJ0aWVzIiwiZ2V0Q29udGV4dCIsImdldFN0YXRlIiwic3RhdGUiLCJzZXRTdGF0ZSIsInVwZGF0ZVN0YXRlIiwidXBkYXRlIiwiYXNzaWduQ29udGV4dCIsInRoZW5EZWxldGUiLCJhcmd1bWVudHNMZW5ndGgiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJmaXJzdEFyZ3VtZW50IiwicHJvcGVydHlOYW1lIiwiZGVzY3JpcHRvciIsImRlZmluZVByb3BlcnR5IiwibW9kdWxlIiwiZXhwb3J0cyIsImVsZW1lbnQiLCJBcnJheSIsInBhcmVudENvbnRleHQiLCJldmVudFR5cGUiLCJzdWJzdHIiLCJ0b0xvd2VyQ2FzZSIsImhhbmRsZXIiLCJvbiIsImtleSIsIm1hdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLFlBQVlDLFFBQVEsY0FBUixDQUFsQjtBQUFBLElBQ01DLGdCQUFnQkQsUUFBUSxtQkFBUixDQUR0QjtBQUFBLElBRU1FLGlCQUFpQkYsUUFBUSxvQkFBUixDQUZ2QjtBQUFBLElBR01HLGtCQUFrQkgsUUFBUSxxQkFBUixDQUh4QjtBQUFBLElBSU1JLG9CQUFvQkosUUFBUSx1QkFBUixDQUoxQjs7QUFNTSxJQUFFSyxLQUFGLEdBQVlILGNBQVosQ0FBRUcsS0FBRjtBQUFBLElBQ0VDLE9BREYsR0FDcUJILGVBRHJCLENBQ0VHLE9BREY7QUFBQSxJQUNXQyxLQURYLEdBQ3FCSixlQURyQixDQUNXSSxLQURYO0FBQUEsSUFFRUMsaUJBRkYsR0FFd0JULFNBRnhCLENBRUVTLGlCQUZGO0FBQUEsSUFHRUMsbUJBSEYsR0FHOENSLGFBSDlDLENBR0VRLG1CQUhGO0FBQUEsSUFHdUJDLGtCQUh2QixHQUc4Q1QsYUFIOUMsQ0FHdUJTLGtCQUh2QjtBQUFBLElBSUVDLG9CQUpGLEdBSTJEUCxpQkFKM0QsQ0FJRU8sb0JBSkY7QUFBQSxJQUl3QkMsOEJBSnhCLEdBSTJEUixpQkFKM0QsQ0FJd0JRLDhCQUp4Qjs7O0FBTU4sU0FBU0MsZUFBVCxHQUFnRjtBQUFBLE1BQXZEQyxVQUF1RCx1RUFBMUMsRUFBMEM7QUFBQSxNQUF0Q0MsaUJBQXNDO0FBQUEsTUFBbkJDLGlCQUFtQjs7QUFDOUVWLFVBQVFRLFVBQVIsRUFBb0JDLGlCQUFwQjs7QUFFQSxNQUFNRSxnQkFBZ0JDLHNDQUFzQyxJQUF0QyxFQUE0Q0osVUFBNUMsQ0FBdEI7O0FBRUFQLFFBQU1PLFVBQU4sRUFBa0JFLGlCQUFsQjs7QUFFQSxNQUFNRyxNQUFPLEtBQUtDLFVBQUwsQ0FBZ0JDLFlBQWhCLEtBQWlDYixpQkFBOUM7QUFBQSxNQUNNYyxRQUFRQyxP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Y29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi4vY29uc3RhbnRzJyksXG4gICAgICBuYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL25hbWUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBvYmplY3RVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvb2JqZWN0JyksXG4gICAgICBlbGVtZW50c1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9lbGVtZW50cycpO1xuXG5jb25zdCB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgY29tYmluZSwgcHJ1bmUgfSA9IG9iamVjdFV0aWxpdGllcyxcbiAgICAgIHsgU1ZHX05BTUVTUEFDRV9VUkkgfSA9IGNvbnN0YW50cyxcbiAgICAgIHsgaXNIVE1MQXR0cmlidXRlTmFtZSwgaXNTVkdBdHRyaWJ1dGVOYW1lIH0gPSBuYW1lVXRpbGl0aWVzLFxuICAgICAgeyByZW1vdmVGYWxzZXlFbGVtZW50cywgcmVwbGFjZVN0cmluZ3NXaXRoVGV4dEVsZW1lbnRzIH0gPSBlbGVtZW50c1V0aWxpdGllcztcblxuZnVuY3Rpb24gYXBwbHlQcm9wZXJ0aWVzKHByb3BlcnRpZXMgPSB7fSwgZGVmYXVsdFByb3BlcnRpZXMsIGlnbm9yZWRQcm9wZXJ0aWVzKSB7XG4gIGNvbWJpbmUocHJvcGVydGllcywgZGVmYXVsdFByb3BlcnRpZXMpO1xuXG4gIGNvbnN0IGNoaWxkRWxlbWVudHMgPSBjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzKHRoaXMsIHByb3BlcnRpZXMpO1xuXG4gIHBydW5lKHByb3BlcnRpZXMsIGlnbm9yZWRQcm9wZXJ0aWVzKTtcblxuICBjb25zdCBzdmcgPSAodGhpcy5kb21FbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRV9VUkkpLFxuICAgICAgICBuYW1lcyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpOyAgLy8vXG5cbiAgbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7XG4gICAgY29uc3QgdmFsdWUgPSBwcm9wZXJ0aWVzW25hbWVdO1xuXG4gICAgaWYgKGZhbHNlKSB7XG4gICAgICAvLy9cbiAgICB9IGVsc2UgaWYgKGlzSGFuZGxlck5hbWUobmFtZSkpIHtcbiAgICAgIGFkZEhhbmRsZXIodGhpcywgbmFtZSwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoaXNBdHRyaWJ1dGVOYW1lKG5hbWUsIHN2ZykpIHtcbiAgICAgIGFkZEF0dHJpYnV0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eSgncHJvcGVydGllcycpKSB7XG4gICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTtcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgICAgICBwcm9wZXJ0aWVzXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnByb3BlcnRpZXNbbmFtZV0gPSB2YWx1ZTtcbiAgICB9XG4gIH0uYmluZCh0aGlzKSk7XG5cbiAgY29uc3QgY29udGV4dCA9IHt9O1xuXG4gIGNoaWxkRWxlbWVudHMuZm9yRWFjaChmdW5jdGlvbihjaGlsZEVsZW1lbnQpIHtcbiAgICB1cGRhdGVDb250ZXh0KGNoaWxkRWxlbWVudCwgY29udGV4dCk7XG5cbiAgICBjaGlsZEVsZW1lbnQuYWRkVG8odGhpcyk7XG4gIH0uYmluZCh0aGlzKSk7XG5cbiAgT2JqZWN0LmFzc2lnbih0aGlzLCBjb250ZXh0KTtcbn1cblxuZnVuY3Rpb24gZ2V0UHJvcGVydGllcygpIHtcbiAgcmV0dXJuIHRoaXMucHJvcGVydGllcztcbn1cblxuZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHtcbiAgcmV0dXJuIHRoaXMuY29udGV4dDtcbn1cblxuZnVuY3Rpb24gZ2V0U3RhdGUoKSB7XG4gIHJldHVybiB0aGlzLnN0YXRlO1xufVxuXG5mdW5jdGlvbiBzZXRTdGF0ZShzdGF0ZSkge1xuICB0aGlzLnN0YXRlID0gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVN0YXRlKHVwZGF0ZSkge1xuICBPYmplY3QuYXNzaWduKHRoaXMuc3RhdGUsIHVwZGF0ZSk7XG59XG5cbmZ1bmN0aW9uIGFzc2lnbkNvbnRleHQobmFtZXMsIHRoZW5EZWxldGUpIHtcbiAgY29uc3QgYXJndW1lbnRzTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDtcblxuICBpZiAoYXJndW1lbnRzTGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgZmlyc3RBcmd1bWVudCA9IGZpcnN0KGFyZ3VtZW50cyk7XG5cbiAgICBpZiAodHlwZW9mIGZpcnN0QXJndW1lbnQgPT09ICdib29sZWFuJykge1xuICAgICAgbmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHQpO1xuXG4gICAgICB0aGVuRGVsZXRlID0gZmlyc3RBcmd1bWVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhlbkRlbGV0ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgaWYgKGFyZ3VtZW50c0xlbmd0aCA9PT0gMCkge1xuICAgIG5hbWVzID0gT2JqZWN0LmtleXModGhpcy5jb250ZXh0KTtcblxuICAgIHRoZW5EZWxldGUgPSB0cnVlO1xuICB9XG5cbiAgbmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvbnRleHRbbmFtZV0sXG4gICAgICAgICAgcHJvcGVydHlOYW1lID0gbmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NyaXB0b3IgPSB7XG4gICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICB9O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgZGVzY3JpcHRvcik7XG5cbiAgICBpZiAodGhlbkRlbGV0ZSkge1xuICAgICAgZGVsZXRlIHRoaXMuY29udGV4dFtuYW1lXTtcbiAgICB9XG4gIH0uYmluZCh0aGlzKSwgW10pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgYXBwbHlQcm9wZXJ0aWVzLFxuICBnZXRQcm9wZXJ0aWVzLFxuICBnZXRDb250ZXh0LFxuICBnZXRTdGF0ZSxcbiAgc2V0U3RhdGUsXG4gIHVwZGF0ZVN0YXRlLFxuICBhc3NpZ25Db250ZXh0XG59O1xuXG5mdW5jdGlvbiBjaGlsZEVsZW1lbnRzRnJvbUVsZW1lbnRBbmRQcm9wZXJ0aWVzKGVsZW1lbnQsIHByb3BlcnRpZXMpIHtcbiAgbGV0IGNoaWxkRWxlbWVudHMgPSAodHlwZW9mIGVsZW1lbnQuY2hpbGRFbGVtZW50cyA9PT0gJ2Z1bmN0aW9uJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGlsZEVsZW1lbnRzKHByb3BlcnRpZXMpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcy5jaGlsZEVsZW1lbnRzO1xuXG4gIGlmICghKGNoaWxkRWxlbWVudHMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICBjaGlsZEVsZW1lbnRzID0gW2NoaWxkRWxlbWVudHNdO1xuICB9XG5cbiAgY2hpbGRFbGVtZW50cyA9IHJlbW92ZUZhbHNleUVsZW1lbnRzKGNoaWxkRWxlbWVudHMpO1xuXG4gIGNoaWxkRWxlbWVudHMgPSByZXBsYWNlU3RyaW5nc1dpdGhUZXh0RWxlbWVudHMoY2hpbGRFbGVtZW50cyk7XG5cbiAgcmV0dXJuIGNoaWxkRWxlbWVudHM7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUNvbnRleHQoY2hpbGRFbGVtZW50LCBjb250ZXh0KSB7XG4gIGNvbnN0IHBhcmVudENvbnRleHQgPSAodHlwZW9mIGNoaWxkRWxlbWVudC5wYXJlbnRDb250ZXh0ID09PSAnZnVuY3Rpb24nKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudC5wYXJlbnRDb250ZXh0KCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudC5jb250ZXh0OyAvLy9cblxuICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHBhcmVudENvbnRleHQpO1xuXG4gIGRlbGV0ZSBjaGlsZEVsZW1lbnQuY29udGV4dDtcbn1cblxuZnVuY3Rpb24gYWRkSGFuZGxlcihlbGVtZW50LCBuYW1lLCB2YWx1ZSkge1xuICBjb25zdCBldmVudFR5cGUgPSBuYW1lLnN1YnN0cigyKS50b0xvd2VyQ2FzZSgpLCAvLy9cbiAgICAgICAgaGFuZGxlciA9IHZhbHVlOyAgLy8vXG5cbiAgZWxlbWVudC5vbihldmVudFR5cGUsIGhhbmRsZXIpO1xufVxuXG5mdW5jdGlvbiBhZGRBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHtcbiAgaWYgKG5hbWUgPT09ICdjbGFzc05hbWUnKSB7XG4gICAgbmFtZSA9ICdjbGFzcyc7XG4gIH1cblxuICBpZiAobmFtZSA9PT0gJ2h0bWxGb3InKSB7XG4gICAgbmFtZSA9ICdmb3InO1xuICB9XG5cbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpO1xuXG4gICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIGVsZW1lbnQuZG9tRWxlbWVudFtuYW1lXVtrZXldID0gdmFsdWVba2V5XTtcbiAgICB9LmJpbmQodGhpcykpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB2YWx1ZSA9IG5hbWU7IC8vL1xuXG4gICAgICBlbGVtZW50LmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGVsZW1lbnQuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0hhbmRsZXJOYW1lKG5hbWUpIHtcbiAgcmV0dXJuIG5hbWUubWF0Y2goL15vbi8pO1xufVxuXG5mdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWUobmFtZSwgc3ZnKSB7XG4gIHJldHVybiBzdmcgPyBpc1NWR0F0dHJpYnV0ZU5hbWUobmFtZSkgOiBpc0hUTUxBdHRyaWJ1dGVOYW1lKG5hbWUpXG59XG4iXX0=